# QUEST FOR GLORY - 代码文档

## 游戏概述

**QUEST FOR GLORY** 是一个基于 TIC-80 平台的 roguelike 游戏，由 Deck 开发。玩家需要在地牢中探索，击败敌人，收集钥匙和药水，最终击败 Boss。

### 基本信息
- **平台**: TIC-80
- **脚本语言**: Lua
- **输入方式**: 游戏手柄
- **游戏类型**: Roguelike

---

## 目录结构

1. [常量定义](#常量定义)
2. [全局变量](#全局变量)
3. [核心系统](#核心系统)
4. [游戏对象类](#游戏对象类)
5. [敌人类型](#敌人类型)
6. [游戏流程](#游戏流程)
7. [游戏机制](#游戏机制)

---

## 常量定义

### 屏幕和地图尺寸
```lua
CAM_W = 240    -- 摄像机宽度（像素）
CAM_H = 136    -- 摄像机高度（像素）
MAP_W = 1920   -- 地图总宽度（像素）
MAP_H = 1088   -- 地图总高度（像素）
CELL = 8       -- 单元格大小（像素），用于地图瓦片
```

### 瓦片类型 (tiles)

游戏使用瓦片 ID 来标识地图上的各种元素：

#### 物品类
- `KEY = 176` - 钥匙
- `HEART = 177` - 生命值图标
- `POTION = 178` - 药水图标

#### 陷阱类
- `SPIKES_HARMLESS = 192` - 无害的尖刺
- `SPIKES_HARM = 193` - 危险的尖刺
- `MIMIC_HARMLESS = 213` - 无害的宝箱怪
- `MIMIC_HARM = 214` - 危险的宝箱怪
- `FOOTBOARD_UP = 230` - 上升的踏板
- `FOOTBOARD_DOWN = 229` - 下降的踏板

#### 容器类
- `CLOSED_COFFER = 194` - 关闭的宝箱
- `OPENED_COFFER = 195` - 打开的宝箱
- `CLOSED_DOOR = 196` - 关闭的门
- `OPENED_DOOR = 197` - 打开的门
- `CLOSED_GRATE = 198` - 关闭的栅栏
- `OPENED_GRATE = 199` - 打开的栅栏

#### 装饰物类
- `SKULL = 208` - 骷髅
- `DESK = 209` - 桌子
- `STATUE_1 = 210` - 雕像1
- `COLUMN = 211` - 柱子
- `CRACK = 212` - 裂缝
- `ALTAR = 217` - 祭坛
- `CHAIR = 218` - 椅子
- `STATUE_2 = 219` - 雕像2

#### 地面物品
- `KEY_FLOOR = 215` - 地面上的钥匙
- `KEY_FLOOR_PICKED_UP = 216` - 已拾取的地面钥匙

#### 环境类
- `WALL_1 = 224` - 墙壁1
- `WALL_2 = 225` - 墙壁2
- `VINE_1/2/3 = 226/227/228` - 藤蔓（3种动画帧）
- `MAGIC_FLUID_1/2/3 = 237/238/239` - 魔法流体（3种动画帧）
- `CRYSTAL_WHOLE = 251` - 完整的水晶
- `CRYSTAL_BROKEN = 252` - 破碎的水晶
- `LAVA_1/2/3 = 253/254/255` - 岩浆（3种动画帧）

---

## 全局变量

```lua
t = 0              -- 全局时间计数器，在 TIC() 函数中递增
cam = {x=0, y=0}   -- 摄像机位置
mobs = {}          -- 所有敌人/怪物的数组
animTiles = {}     -- 动画瓦片数组
traps = {}         -- 陷阱数组
bullets = {}       -- 子弹数组
firstRun = true    -- 首次运行标志，用于游戏重置
```

---

## 核心系统

### 1. 碰撞检测系统 (Collision)

#### `Collision:GetEdges(x, y, w, h)`
获取对象四个角的瓦片 ID。

**参数:**
- `x, y`: 对象位置
- `w, h`: 对象宽度和高度（可选，默认 CELL-1）

**返回:** 四个角的瓦片 ID (topLeft, topRight, bottomLeft, bottomRight)

#### `Collision:CheckSolid(indx)`
检查瓦片是否为固体（不可通过）。

**返回:** 布尔值，表示是否为固体

**固体类型包括:**
- 墙壁 (WALL_1, WALL_2)
- 关闭的栅栏 (CLOSED_GRATE)
- 危险的宝箱怪 (MIMIC_HARM)
- 柱子、桌子、雕像、祭坛
- 完整的水晶 (CRYSTAL_WHOLE)
- 关闭的门 (CLOSED_DOOR)
- 宝箱（关闭或打开）

#### `Collision:CheckDanger(indx)`
检查瓦片是否为危险（会造成伤害）。

**返回:** 布尔值，表示是否为危险

**危险类型包括:**
- 岩浆 (LAVA_1/2/3)
- 危险的宝箱怪 (MIMIC_HARM)
- 危险的尖刺 (SPIKES_HARM)
- 下降的踏板 (FOOTBOARD_DOWN)

---

### 2. 动画系统 (Anim)

#### `Anim(span, frames, loop)`
创建动画对象。

**参数:**
- `span`: 每帧持续时间（游戏帧数）
- `frames`: 动画帧数组（瓦片 ID 数组）
- `loop`: 是否循环（可选，默认 true）

**方法:**
- `Update(time)`: 更新动画，根据时间切换到下一帧
- `RandomIndx()`: 随机设置当前帧索引
- `Reset()`: 重置动画到第一帧

**属性:**
- `frame`: 当前显示的瓦片 ID
- `indx`: 当前帧索引
- `ended`: 动画是否结束（仅非循环动画）

---

### 3. 动画瓦片系统 (AnimTile)

#### `AnimTile(cellX, cellY, anim)`
创建动画瓦片对象，用于地图上的动态元素。

**参数:**
- `cellX, cellY`: 瓦片在地图上的单元格坐标
- `anim`: 动画对象

**方法:**
- `Display(time)`: 更新并显示动画瓦片

**用途:** 用于岩浆、魔法流体、藤蔓等需要动画的地图元素。

---

### 4. 陷阱系统 (Trap)

#### `Trap(cellX, cellY, idSafe, idDanger)`
创建陷阱对象，在安全状态和危险状态之间切换。

**参数:**
- `cellX, cellY`: 陷阱位置（单元格坐标）
- `idSafe`: 安全状态的瓦片 ID
- `idDanger`: 危险状态的瓦片 ID

**属性:**
- `timeSafe`: 安全状态持续时间（默认 180 帧）
- `timeDanger`: 危险状态持续时间（默认 120 帧）
- `dangerous`: 当前是否为危险状态（随机初始化）

**方法:**
- `Update(time)`: 根据时间切换陷阱状态
- `Display(time)`: 更新地图上的陷阱瓦片

**陷阱类型:**
1. **尖刺陷阱** (SPIKES_HARMLESS/HARM)
   - 危险时间: 40-80 帧
   - 安全时间: 40-80 帧

2. **宝箱怪陷阱** (MIMIC_HARMLESS/HARM)
   - 危险时间: 40-60 帧
   - 安全时间: 40-120 帧

3. **踏板陷阱** (FOOTBOARD_UP/DOWN)
   - 危险时间: 40-60 帧
   - 安全时间: 210-240 帧

---

## 游戏对象类

### 1. 子弹类 (Bullet)

#### `Bullet(x, y, vx, vy)`
创建子弹对象，用于远程攻击。

**参数:**
- `x, y`: 初始位置
- `vx, vy`: 速度向量

**属性:**
- `tag = "bullet"`: 对象标签
- `anims`: 动画字典 {move, collided}
- `alpha = 8`: 透明度
- `range = 4*CELL`: 最大射程
- `power = 1`: 伤害值
- `player`: 目标玩家对象
- `collided`: 是否已碰撞
- `visible`: 是否在摄像机视野内

**方法:**
- `Move()`: 移动子弹，检测碰撞
- `Collide()`: 处理碰撞事件
- `Update(time)`: 更新子弹状态
- `Display(time)`: 显示子弹

**行为:**
- 检测与墙壁等固体的碰撞
- 检测与玩家的碰撞并造成伤害
- 超出射程后自动销毁
- 碰撞后播放碰撞动画并销毁

---

### 2. 怪物基类 (Mob)

#### `Mob(x, y, player)`
所有敌人的基类。

**参数:**
- `x, y`: 初始位置
- `player`: 玩家对象引用

**属性:**
- `tag = "mob"`: 对象标签
- `anims`: 动画字典 {idle, walk, attack, die, damaged}
- `health = 3`: 生命值
- `power = 1`: 攻击力
- `fov = 6*CELL`: 视野范围
- `proximity = CELL-2`: 攻击距离
- `speed`: 移动速度（0.3-0.4，随机）
- `minAttackDelay = 30`: 最小攻击间隔
- `maxAttackDelay = 100`: 最大攻击间隔
- `damageable = true`: 是否受陷阱伤害
- `score = 0`: 击败后获得的分数

**状态:**
- `died`: 是否死亡
- `attack`: 是否正在攻击
- `damaged`: 是否正在受伤害
- `visible`: 是否在摄像机视野内

**方法:**
- `Move(dx, dy)`: 移动怪物
- `Attack()`: 攻击玩家
- `Damaged(amount)`: 受到伤害
- `Die()`: 死亡处理
- `Update(time)`: 更新怪物 AI 和状态
- `Display(time)`: 显示怪物

**AI 行为:**
1. 检测玩家是否在视野范围内
2. 如果在视野内，向玩家移动
3. 到达攻击距离时，定期攻击玩家
4. 检测是否踩到危险瓦片（如果 damageable=true）
5. 死亡时给玩家增加分数

---

### 3. 施法者怪物类 (MobCaster)

#### `MobCaster(x, y, player)`
继承自 `Mob`，可以发射子弹的怪物。

**特殊属性:**
- `minAttackDelay = 90`: 最小攻击间隔
- `maxAttackDelay = 180`: 最大攻击间隔
- `fov = 8*CELL`: 更大的视野范围
- `proximity = 4*CELL`: 更大的攻击距离

**方法:**
- `CreateBullet(x, y, vx, vy)`: 创建子弹对象（需子类实现）
- `Attack()`: 重写攻击方法，发射子弹而不是近战攻击

**攻击机制:**
- 计算到玩家的角度
- 创建子弹并设置方向
- 将子弹添加到全局 bullets 数组

---

### 4. Boss 类 (Boss)

#### `Boss(x, y, player)`
继承自 `MobCaster`，最终 Boss。

**特殊属性:**
- `health = 10`: 更高的生命值
- `score = 15`: 击败后获得高分数
- `damageable = false`: 不受陷阱伤害
- `minAttackDelay = 40`: 更快的攻击频率
- `maxAttackDelay = 120`

**特殊行为:**
1. **多重子弹攻击**: 每次攻击发射 6 发子弹，方向随机
2. **双格高度**: 显示时需要绘制两个瓦片（身体和头部）
3. **特殊碰撞检测**: 需要检测两个格子的碰撞

**动画:**
- idle: {128, 129, 130, 131}
- walk: {128, 129, 130, 131}
- attack: {132, 133, 128}
- die: {132, 137, 138, 139, 140, 141}
- damaged: {142, 128}

---

### 5. 玩家类 (Player)

#### `Player(x, y)`
继承自 `Mob`，玩家角色。

**特殊属性:**
- `keys = 0`: 钥匙数量
- `potions = 0`: 药水数量
- `health = 5`: 生命值
- `maxHealth = 5`: 最大生命值
- `points = 0`: 分数

**输入控制:**
- `btn(0)`: 向上移动
- `btn(1)`: 向下移动
- `btn(2)`: 向左移动
- `btn(3)`: 向右移动
- `btn(4)`: 攻击（Z 键）
- `btn(5)`: 使用药水（X 键）

**特殊方法:**
- `CheckDoors(dx, dy)`: 检查并开启门（需要钥匙）
- `CheckCoffers(dx, dy)`: 检查并打开宝箱（70% 概率获得药水）
- `CheckKeys(dx, dy)`: 检查并拾取地面上的钥匙

**游戏机制:**
1. 使用药水可以恢复满生命值
2. 药水上限为 5 个
3. 攻击时检测与敌人的碰撞
4. 检测危险瓦片并受到伤害

---

## 敌人类型

### 1. Blob（史莱姆）
- **生成函数**: `SpawnBlob(cellX, cellY, player)`
- **生命值**: 2
- **分数**: 1
- **特点**: 
  - 不受陷阱伤害 (`damageable = false`)
  - 移动速度快
  - 动画帧: {32-45}

### 2. Goblin（哥布林）
- **生成函数**: `SpawnGoblin(cellX, cellY, player)`
- **生命值**: 3（默认）
- **分数**: 2
- **特点**: 基础近战敌人
- **动画帧**: {48-57}

### 3. Wraith（幽灵）
- **生成函数**: `SpawnWraith(cellX, cellY, player)`
- **生命值**: 6
- **分数**: 4
- **攻击力**: 2
- **特点**: 
  - 远程攻击（发射子弹）
  - 不受陷阱伤害
  - 视野范围: 8*CELL
- **动画帧**: {80-95}

### 4. Golem（石像鬼）
- **生成函数**: `SpawnGolem(cellX, cellY, player)`
- **生命值**: 7
- **分数**: 6
- **攻击力**: 2
- **特点**: 
  - 视野范围较小 (4*CELL)
  - 高生命值
- **动画帧**: {64-75}

### 5. Knight（骑士）
- **生成函数**: `SpawnKnight(cellX, cellY, player)`
- **生命值**: 10
- **分数**: 7
- **特点**: 
  - 高生命值
  - 视野范围: 7*CELL
- **动画帧**: {96-106}

---

## 游戏流程

### 初始化 (Init)

`Init()` 函数在游戏首次运行时执行：

1. **清理数组**: 清空 mobs、animTiles、traps、bullets
2. **创建玩家**: 在 (8*CELL, 6*CELL) 位置创建玩家
3. **创建 Boss**: 在 (124*CELL, 24*CELL) 位置创建 Boss
4. **生成敌人**: 在地图各处生成各种敌人
5. **初始化地图元素**:
   - 为岩浆、魔法流体、藤蔓创建动画瓦片
   - 为陷阱创建陷阱对象
   - 重置门、宝箱、钥匙状态
   - 重置特殊区域（石像鬼房间、Boss 栅栏）

### 特殊事件 (SpecialEvents)

`SpecialEvents()` 处理游戏中的特殊触发事件：

1. **石像鬼房间**:
   - 玩家进入房间时关闭入口（水晶变为完整状态）
   - 两个石像鬼都死亡后重新打开入口

2. **Boss 房间**:
   - 玩家接近 Boss 时关闭栅栏，防止逃跑

### 主循环 (TIC)

`TIC()` 是 TIC-80 的主循环函数，每帧执行一次：

1. **初始化检查**: 如果是首次运行，执行 Init()
2. **重置检查**: 如果玩家死亡或 Boss 死亡，按 X 键重置游戏
3. **摄像机更新**: 根据玩家位置更新摄像机
4. **地图绘制**: 绘制当前摄像机视野内的地图
5. **更新阶段**:
   - 执行特殊事件
   - 更新所有怪物
   - 更新玩家
   - 更新子弹（移除已死亡的）
   - 更新陷阱
6. **绘制阶段**:
   - 绘制动画瓦片
   - 绘制怪物
   - 绘制玩家
   - 绘制子弹
   - 绘制陷阱
   - 绘制 HUD
   - 绘制游戏消息
7. **时间递增**: `t = t + 1`

---

## 游戏机制

### 1. 摄像机系统

摄像机跟随玩家，使用网格对齐：
```lua
cam.x = p1.x - p1.x % (CAM_W - CELL)
cam.y = p1.y - p1.y % (CAM_H - CELL)
```

这确保摄像机以单元格为单位移动，提供平滑的滚动效果。

### 2. 碰撞检测

使用四角检测法：
- 获取对象四个角的瓦片 ID
- 检查每个角是否为固体
- 如果所有角都不是固体，允许移动

### 3. 视野系统

怪物和子弹只在摄像机视野内时才会更新和绘制，优化性能：
```lua
visible = x >= cam.x and x <= cam.x + CAM_W - CELL and 
         y >= cam.y and y <= cam.y + CAM_H - CELL
```

### 4. 伤害系统

**伤害来源:**
1. 敌人攻击（近战或远程）
2. 危险瓦片（岩浆、尖刺、陷阱等）
3. 玩家攻击敌人

**伤害处理:**
- 播放受伤害动画
- 减少生命值
- 生命值 <= 0 时触发死亡

### 5. 物品系统

**钥匙:**
- 从地面拾取
- 用于开启关闭的门
- 开启门时消耗 1 把钥匙

**药水:**
- 从宝箱中获取（70% 概率）
- 上限 5 个
- 使用后恢复满生命值

### 6. 分数系统

击败敌人获得分数：
- Blob: 1 分
- Goblin: 2 分
- Wraith: 4 分
- Golem: 6 分
- Knight: 7 分
- Boss: 15 分

### 7. HUD 显示

`DisplayHUD()` 显示：
- 分数（右上角）
- 生命值（心形图标，右上角）
- 药水数量（药水图标）
- 钥匙数量（钥匙图标）

### 8. 游戏消息

`DisplayMessages()` 显示：
- 玩家死亡时显示 "YOU DIED"，提示按 X 重启
- Boss 死亡时显示 "YOU WIN"，提示按 X 重启

---

## 调试工具

### PrintDebug(object)

用于调试的函数，打印对象的所有属性：
- 打印基本类型（数字、字符串）
- 打印布尔值
- 打印表格的键
- 标识函数类型

---

## 代码结构总结

```
ref.lua
├── 常量定义
│   ├── 屏幕/地图尺寸
│   └── 瓦片类型表
├── 全局变量
│   ├── 时间、摄像机
│   └── 游戏对象数组
├── 核心系统
│   ├── Collision (碰撞检测)
│   ├── Anim (动画)
│   ├── AnimTile (动画瓦片)
│   └── Trap (陷阱)
├── 游戏对象类
│   ├── Bullet (子弹)
│   ├── Mob (怪物基类)
│   ├── MobCaster (施法者)
│   ├── Boss (Boss)
│   └── Player (玩家)
├── 敌人生成函数
│   ├── SpawnBlob
│   ├── SpawnGoblin
│   ├── SpawnWraith
│   ├── SpawnGolem
│   └── SpawnKnight
├── 游戏流程
│   ├── Init (初始化)
│   ├── SpecialEvents (特殊事件)
│   └── TIC (主循环)
└── UI 函数
    ├── DisplayHUD
    └── DisplayMessages
```

---

## 注意事项

1. **性能优化**: 使用视野检测，只更新和绘制可见对象
2. **碰撞精度**: 使用四角检测，提供更精确的碰撞判断
3. **状态管理**: 使用标志位（died, attack, damaged）管理对象状态
4. **动画系统**: 统一的动画系统，支持循环和非循环动画
5. **游戏重置**: 通过 `firstRun` 标志实现游戏重置功能

---

## 扩展建议

1. **添加新敌人**: 创建新的 Spawn 函数，设置动画和属性
2. **添加新陷阱**: 在 Init() 中添加陷阱检测和创建逻辑
3. **添加新物品**: 在 Player 类中添加新的检查函数
4. **优化 AI**: 修改 Mob 类的 Update() 方法
5. **添加音效**: 在关键事件处添加 sfx() 调用

---

**文档版本**: 1.0  
**最后更新**: 2026
